@model kurssienhallinta.Models.ViewModels.StudentScheduleViewModel

<h2>Opiskelijan viikkoaikataulu</h2>

<div class="week-navigation">
    <a asp-action="Weekly" asp-route-id="@Model.Student?.Id" asp-route-weekOffset="@(Model.WeekOffset - 1)"
        class="btn btn-secondary">← Edellinen viikko</a>

    <div class="week-info">
        <strong>Viikko @GetWeekNumber(Model.WeekStart)</strong>
        <p>@Model.WeekStart.ToString("dd.MM.yyyy") - @Model.WeekEnd.ToString("dd.MM.yyyy")</p>
    </div>

    <a asp-action="Weekly" asp-route-id="@Model.Student?.Id" asp-route-weekOffset="@(Model.WeekOffset + 1)"
        class="btn btn-secondary">Seuraava viikko →</a>
</div>

<div class="schedule-container">
    <div class="time-column">
        <div class="time-header">Time</div>
        @foreach (var timeSlot in GetAllTimeSlots())
        {
            <div class="time-slot">
                @timeSlot.ToString(@"hh\:mm")
            </div>
        }
    </div>

    @foreach (var day in GetAllDays())
    {
        <div class="day-column">
            <div class="day-header">@day</div>

            @foreach (var timeSlot in GetAllTimeSlots())
            {
                var course = Model.WeeklySchedule.ContainsKey(day)
                ? Model.WeeklySchedule[day].FirstOrDefault(c => c.Start_time == timeSlot)
                : null;

                var isAlreadySpanned = Model.WeeklySchedule.ContainsKey(day)
                ? Model.WeeklySchedule[day].Any(c => c.Start_time < timeSlot && c.End_time > timeSlot)
                : false;

                @if (!isAlreadySpanned)
                {
                    @if (course != null)
                    {
                        var hours = (int)(course.End_time - course.Start_time).TotalHours;
                        var height = hours * 80;

                        <div class="course-block" style="height: @(height)px;">
                            <div>
                                <strong>@course.Name</strong>
                                <p>@course.Room?.Name</p>
                                <p>@course.Start_time.ToString(@"hh\:mm")–@course.End_time.ToString(@"hh\:mm")</p>
                            </div>
                        </div>
                    }
                    else
                    {
                        <div class="empty-slot"></div>
                    }
                }
            }
        </div>
    }
</div>

@functions {
    private List<string> GetAllDays() =>
    new List<string> { "Monday", "Tuesday", "Wednesday", "Thursday", "Friday" };

    private List<TimeSpan> GetAllTimeSlots()
    {
        var slots = new List<TimeSpan>();
        for (int hour = 8; hour <= 15; hour++)
            slots.Add(new TimeSpan(hour, 0, 0));
        return slots;
    }

    private int GetWeekNumber(DateTime date) =>
    System.Globalization.CultureInfo.CurrentCulture.Calendar.GetWeekOfYear(
    date,
    System.Globalization.CalendarWeekRule.FirstFourDayWeek,
    DayOfWeek.Monday
    );
}